---
// Floating chat widget that appears in bottom-right corner
---

<section id="chat-widget-container" class="fixed bottom-6 right-6 z-9999 font-sans sm:bottom-4 sm:right-4" role="complementary" aria-label="Chat assistant">
  <!-- Floating chat button -->
  <button id="chat-toggle-btn" class="w-16 h-16 rounded-full bg-linear-to-br from-violet-500 via-purple-500 to-fuchsia-500 border border-white/40 dark:border-purple-700/80 ring-1 ring-white/20 dark:ring-purple-500/30 cursor-pointer shadow-[0_12px_30px_-10px_rgba(124,58,237,0.8)] flex items-center justify-center transition-all duration-300 hover:scale-110 hover:shadow-[0_18px_40px_-12px_rgba(124,58,237,0.9)] active:scale-95 animate-pulse-slow" aria-label="Open chat">
    <span id="notification-badge" class="absolute -top-1 -right-1 w-6 h-6 bg-linear-to-r from-rose-500 to-pink-500 rounded-full flex items-center justify-center text-[11px] font-bold text-white shadow-lg shadow-rose-500/50 opacity-0 scale-0 transition-all duration-200">1</span>
    <svg class="chat-icon w-7 h-7 text-white transition-all duration-300 opacity-100 scale-100 drop-shadow-md" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <svg class="close-icon w-7 h-7 text-white transition-all duration-300 absolute opacity-0 scale-0 drop-shadow-md" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <!-- Chat window -->
  <aside id="chat-widget-window" class="absolute bottom-20 right-0 w-[400px] sm:w-[min(400px,calc(100vw-32px))] h-[560px] sm:h-[min(560px,calc(100vh-100px))] rounded-3xl shadow-[0_30px_80px_-30px_rgba(124,58,237,0.55)] opacity-0 translate-y-3 scale-95 pointer-events-none transition-all duration-300 ease-out overflow-hidden bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-white/40 dark:border-slate-700/60 ring-1 ring-purple-500/10" role="dialog" aria-label="Chat window">
    
    <!-- Header -->
    <header class="h-[72px] px-5 flex justify-between items-center bg-linear-to-r from-violet-600 via-purple-600 to-fuchsia-600 relative border-b border-white/10">
      <hgroup class="flex items-center gap-4">
        <figure class="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-inner m-0">
          <svg class="w-6 h-6 text-white drop-shadow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </figure>
        <div>
          <h3 class="m-0 text-base text-white font-bold leading-tight tracking-tight">AI Assistant</h3>
          <p class="m-0 mt-1 text-xs text-white/90 flex items-center gap-2 font-medium">
            <span class="w-2.5 h-2.5 bg-emerald-400 rounded-full animate-pulse shadow-sm shadow-emerald-400/50" aria-hidden="true"></span>
            Online
          </p>
        </div>
      </hgroup>
      <nav class="flex gap-2" aria-label="Chat controls">
        <button id="chat-clear-btn" class="w-9 h-9 rounded-xl flex items-center justify-center text-white/80 hover:text-white hover:bg-white/15 transition-all duration-200" aria-label="Clear chat" title="Clear chat">
          <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"></path>
          </svg>
        </button>
        <button id="chat-minimize-btn" class="w-9 h-9 rounded-xl flex items-center justify-center text-white/80 hover:text-white hover:bg-white/15 transition-all duration-200" aria-label="Close chat" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </nav>
    </header>

    <!-- Chat body -->
    <main id="widget-chat-body" class="h-[calc(100%-152px)] overflow-y-auto px-2 py-4 flex flex-col gap-3 bg-linear-to-b from-slate-50 via-white to-purple-50/40 dark:from-slate-900 dark:via-slate-900 dark:to-purple-950/30 chat-scrollbar" role="log" aria-live="polite" aria-label="Chat messages"></main>

    <!-- Input area -->
    <footer class="h-20 px-5 py-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-t border-white/30 dark:border-slate-700/50">
      <form id="widget-chat-form" class="flex gap-3 items-center h-full">
        <div class="flex-1 relative">
          <input
            id="widget-chat-input"
            type="text"
            placeholder="Type a message..."
            autocomplete="off"
            aria-label="Message"
            maxlength="1000"
            class="w-full h-12 px-5 rounded-2xl border border-purple-200/70 dark:border-purple-800/50 bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-slate-100 text-sm placeholder-slate-400 dark:placeholder-slate-500 outline-none transition-all duration-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/20 disabled:opacity-50 disabled:cursor-not-allowed shadow-inner shadow-purple-500/5"
          />
        </div>
        <button type="submit" aria-label="Send message" class="w-12 h-12 rounded-2xl bg-linear-to-br from-violet-500 to-fuchsia-500 text-white flex items-center justify-center transition-all duration-200 hover:scale-105 hover:shadow-lg hover:shadow-purple-500/30 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_10px_20px_-10px_rgba(124,58,237,0.7)]">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </footer>
  </aside>
</section>

<script is:inline>
(() => {
  const toggleBtn = document.getElementById('chat-toggle-btn');
  const minimizeBtn = document.getElementById('chat-minimize-btn');
  const clearBtn = document.getElementById('chat-clear-btn');
  const chatWindow = document.getElementById('chat-widget-window');
  const chatBody = document.getElementById('widget-chat-body');
  const chatForm = document.getElementById('widget-chat-form');
  const chatInput = document.getElementById('widget-chat-input');
  const notificationBadge = document.getElementById('notification-badge');
  const STORAGE_KEY = 'chat-widget-messages-v2';

  let isOpen = false;
  let typing = false;
  let messages = loadMessages();

  function loadMessages() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) return JSON.parse(stored);
    } catch (_) {}
    return [];
  }

  function persist() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    } catch (_) {}
  }

  function render() {
    chatBody.innerHTML = '';
    
    if (messages.length === 0) {
      const welcomeSection = document.createElement('section');
      welcomeSection.className = 'p-6 rounded-2xl bg-white dark:bg-slate-800 border-2 border-purple-100 dark:border-purple-900/40 shadow-lg shadow-purple-500/5';
      welcomeSection.setAttribute('aria-label', 'Welcome message');
      welcomeSection.innerHTML = `
        <header class="flex items-center gap-4 mb-5">
          <figure class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-purple-500/30 m-0">
            <span class="text-2xl" role="img" aria-label="Robot">ü§ñ</span>
          </figure>
          <hgroup>
            <p class="text-slate-800 dark:text-slate-100 text-base font-bold m-0">AI Assistant</p>
            <p class="text-purple-500 dark:text-purple-400 text-sm m-0 font-medium">Ready to help ‚ú®</p>
          </hgroup>
        </header>
        <p class="text-slate-600 dark:text-slate-300 text-sm m-0 mb-5 leading-relaxed">Hi there! I'm here to help you with this project. What would you like to know?</p>
        <nav class="flex flex-col gap-3" aria-label="Quick actions">
          <button class="quick-action-btn flex items-center gap-3 px-4 py-3.5 rounded-xl bg-gradient-to-r from-violet-50 to-fuchsia-50 dark:from-violet-900/30 dark:to-fuchsia-900/30 hover:from-violet-100 hover:to-fuchsia-100 dark:hover:from-violet-900/50 dark:hover:to-fuchsia-900/50 border-2 border-purple-200 dark:border-purple-800/50 text-slate-700 dark:text-slate-200 text-sm font-medium transition-all duration-200 hover:border-purple-400 dark:hover:border-purple-600 hover:shadow-md hover:shadow-purple-500/10">
            <span class="text-lg">üöÄ</span>
            <span>How do I run the project?</span>
          </button>
          <button class="quick-action-btn flex items-center gap-3 px-4 py-3.5 rounded-xl bg-gradient-to-r from-violet-50 to-fuchsia-50 dark:from-violet-900/30 dark:to-fuchsia-900/30 hover:from-violet-100 hover:to-fuchsia-100 dark:hover:from-violet-900/50 dark:hover:to-fuchsia-900/50 border-2 border-purple-200 dark:border-purple-800/50 text-slate-700 dark:text-slate-200 text-sm font-medium transition-all duration-200 hover:border-purple-400 dark:hover:border-purple-600 hover:shadow-md hover:shadow-purple-500/10">
            <span class="text-lg">üì¶</span>
            <span>What's the tech stack?</span>
          </button>
          <button class="quick-action-btn flex items-center gap-3 px-4 py-3.5 rounded-xl bg-gradient-to-r from-violet-50 to-fuchsia-50 dark:from-violet-900/30 dark:to-fuchsia-900/30 hover:from-violet-100 hover:to-fuchsia-100 dark:hover:from-violet-900/50 dark:hover:to-fuchsia-900/50 border-2 border-purple-200 dark:border-purple-800/50 text-slate-700 dark:text-slate-200 text-sm font-medium transition-all duration-200 hover:border-purple-400 dark:hover:border-purple-600 hover:shadow-md hover:shadow-purple-500/10">
            <span class="text-lg">üåê</span>
            <span>How do I deploy this?</span>
          </button>
        </nav>
      `;
      chatBody.appendChild(welcomeSection);
      
      welcomeSection.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const text = btn.querySelector('span:last-child').textContent.trim();
          chatInput.value = text;
          handleSubmit(new Event('submit'));
        });
      });
      return;
    }
    
    messages.forEach((msg) => {
      const isBot = msg.role === 'bot';
      const article = document.createElement('article');
      article.className = `flex ${isBot ? 'justify-start ml-2' : 'justify-end mr-2'} animate-fadeIn`;
      article.setAttribute('role', 'article');
      article.setAttribute('aria-label', `${isBot ? 'Assistant' : 'User'} message`);
      
      const messageBox = document.createElement('div');
      messageBox.className = isBot 
        ? 'max-w-[80%] px-4 py-2.5 rounded-2xl rounded-tl-md bg-white dark:bg-slate-800 shadow-md'
        : 'max-w-[80%] px-4 py-2.5 rounded-2xl rounded-tr-md bg-gradient-to-br from-violet-500 to-purple-600 shadow-md';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'flex flex-col gap-1';
      
      const messageText = document.createElement('p');
      messageText.className = isBot
        ? 'm-0 text-sm leading-relaxed text-slate-800 dark:text-slate-100 whitespace-pre-wrap break-words'
        : 'm-0 text-sm leading-relaxed text-white whitespace-pre-wrap break-words';
      messageText.textContent = msg.text;
      
      const timestamp = document.createElement('time');
      timestamp.className = isBot
        ? 'text-[10px] text-slate-400 dark:text-slate-500 self-end'
        : 'text-[10px] text-white/70 self-end';
      timestamp.textContent = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestamp.setAttribute('datetime', new Date(msg.ts).toISOString());
      
      messageContent.appendChild(messageText);
      messageContent.appendChild(timestamp);
      messageBox.appendChild(messageContent);
      article.appendChild(messageBox);
      chatBody.appendChild(article);
    });

    if (typing) {
      const typingIndicator = document.createElement('aside');
      typingIndicator.className = 'flex justify-start ml-2 animate-fadeIn';
      typingIndicator.setAttribute('aria-label', 'Assistant is typing');
      typingIndicator.setAttribute('role', 'status');
      const typingContent = document.createElement('div');
      typingContent.className = 'px-4 py-3 rounded-2xl rounded-tl-md bg-white dark:bg-slate-800 shadow-md flex items-center gap-1.5';
      typingContent.innerHTML = `
        <span class="w-2 h-2 bg-purple-400 dark:bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0ms" aria-hidden="true"></span>
        <span class="w-2 h-2 bg-purple-400 dark:bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms" aria-hidden="true"></span>
        <span class="w-2 h-2 bg-purple-400 dark:bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms" aria-hidden="true"></span>
      `;
      typingIndicator.appendChild(typingContent);
      chatBody.appendChild(typingIndicator);
    }

    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function addMessage(role, text) {
    messages.push({ id: Date.now(), role, text, ts: Date.now() });
    persist();
    render();
  }

  async function callAPI(userMessage) {
    try {
      const conversationHistory = messages.map((m) => ({
        role: m.role === 'bot' ? 'assistant' : 'user',
        content: m.text,
      }));

      try {
        const { default: ChatbotModel } = await import('/src/lib/chatbot-model.js');
        const chatbot = new ChatbotModel();
        const reply = chatbot.generateResponse(userMessage, conversationHistory);
        if (!reply || reply.trim().length === 0) throw new Error('Empty response');
        return reply;
      } catch (importError) {
        console.error('Chatbot error:', importError);
        return 'I\'m having trouble right now. Quick tips:\n\n‚Ä¢ Run: pnpm run dev\n‚Ä¢ Build: pnpm run build\n‚Ä¢ Check docs/ for guides\n\nTry refreshing the page.';
      }
    } catch (error) {
      return 'Something went wrong. Please try again.';
    }
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const value = chatInput.value.trim();
    if (!value || typing) return;
    if (value.length > 1000) {
      addMessage('bot', 'Message too long. Please keep it under 1000 characters.');
      return;
    }

    addMessage('user', value);
    chatInput.value = '';
    chatInput.disabled = true;
    typing = true;
    render();

    try {
      const reply = await callAPI(value);
      typing = false;
      addMessage('bot', reply);
    } catch (error) {
      typing = false;
      addMessage('bot', 'Sorry, something went wrong. Please try again.');
    } finally {
      chatInput.disabled = false;
      chatInput.focus();
    }
  }

  function toggleChat() {
    isOpen = !isOpen;
    const chatIcon = toggleBtn.querySelector('.chat-icon');
    const closeIcon = toggleBtn.querySelector('.close-icon');
    
    if (isOpen) {
      chatWindow.classList.remove('opacity-0', 'translate-y-3', 'scale-95', 'pointer-events-none');
      chatWindow.classList.add('opacity-100', 'translate-y-0', 'scale-100', 'pointer-events-auto');
      chatIcon.classList.remove('opacity-100', 'scale-100');
      chatIcon.classList.add('opacity-0', 'scale-0');
      closeIcon.classList.remove('opacity-0', 'scale-0');
      closeIcon.classList.add('opacity-100', 'scale-100');
      notificationBadge?.classList.remove('opacity-100', 'scale-100');
      notificationBadge?.classList.add('opacity-0', 'scale-0');
      setTimeout(() => chatInput.focus(), 100);
    } else {
      chatWindow.classList.remove('opacity-100', 'translate-y-0', 'scale-100', 'pointer-events-auto');
      chatWindow.classList.add('opacity-0', 'translate-y-3', 'scale-95', 'pointer-events-none');
      chatIcon.classList.remove('opacity-0', 'scale-0');
      chatIcon.classList.add('opacity-100', 'scale-100');
      closeIcon.classList.remove('opacity-100', 'scale-100');
      closeIcon.classList.add('opacity-0', 'scale-0');
    }
  }

  function clearChat() {
    if (confirm('Clear all messages?')) {
      messages = [];
      persist();
      render();
    }
  }

  clearBtn?.addEventListener('click', clearChat);
  toggleBtn.addEventListener('click', toggleChat);
  minimizeBtn.addEventListener('click', toggleChat);
  chatForm.addEventListener('submit', handleSubmit);
  render();
})();
</script>

<style>
  .chat-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #c4b5fd transparent;
  }
  .chat-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .chat-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .chat-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #a78bfa, #c084fc);
    border-radius: 10px;
  }
  .chat-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #8b5cf6, #a855f7);
  }
  .dark .chat-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #7c3aed, #9333ea);
  }
  .dark .chat-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #8b5cf6, #a855f7);
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  .animate-fadeIn {
    animation: fadeIn 0.25s ease-out;
  }
  @keyframes pulse-slow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4); }
    50% { box-shadow: 0 0 0 12px rgba(147, 51, 234, 0); }
  }
  .animate-pulse-slow {
    animation: pulse-slow 2s ease-in-out infinite;
  }
</style>
